name: Benchmarks

on:
  schedule:
    # Run benchmarks every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'benchmarks/**'

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cc: gcc
          - os: macos-latest
            cc: clang
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build benchmark
      run: |
        make clean
        make CC=${{ matrix.cc }} benchmark
    
    - name: Run benchmark
      run: |
        ./build/benchmark_ss_lib | tee benchmark_results.txt
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ matrix.os }}
        path: benchmark_results.txt
    
    - name: Run comprehensive benchmarks
      if: matrix.os == 'ubuntu-latest'
      run: |
        chmod +x benchmarks/run_benchmarks.sh
        ./benchmarks/run_benchmarks.sh || true
    
    - name: Upload comprehensive results
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-benchmark-results
        path: build/benchmarks/

  benchmark-comparison:
    name: Benchmark Comparison
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run benchmarks on PR branch
      run: |
        make clean
        make benchmark
        ./build/benchmark_ss_lib > pr_results.txt
    
    - name: Run benchmarks on base branch
      run: |
        git fetch origin ${{ github.base_ref }}
        git checkout origin/${{ github.base_ref }}
        make clean
        make benchmark
        ./build/benchmark_ss_lib > base_results.txt
    
    - name: Compare benchmarks
      run: |
        echo "## Benchmark Comparison" > comparison.md
        echo "" >> comparison.md
        echo "### Base Branch (${{ github.base_ref }})" >> comparison.md
        echo '```' >> comparison.md
        tail -20 base_results.txt >> comparison.md
        echo '```' >> comparison.md
        echo "" >> comparison.md
        echo "### Current Branch" >> comparison.md
        echo '```' >> comparison.md
        tail -20 pr_results.txt >> comparison.md
        echo '```' >> comparison.md
        
        # Simple comparison script
        cat > compare.py << 'EOF'
        import re
        import sys
        
        def parse_results(filename):
            results = {}
            with open(filename, 'r') as f:
                for line in f:
                    match = re.match(r'^(.+?):\s*avg=\s*(\d+)\s*ns', line)
                    if match:
                        name = match.group(1).strip()
                        avg = int(match.group(2))
                        results[name] = avg
            return results
        
        base = parse_results('base_results.txt')
        current = parse_results('pr_results.txt')
        
        print("\n### Performance Changes\n")
        print("| Benchmark | Base (ns) | Current (ns) | Change |")
        print("|-----------|-----------|--------------|--------|")
        
        for name in sorted(set(base.keys()) | set(current.keys())):
            if name in base and name in current:
                b = base[name]
                c = current[name]
                change = ((c - b) / b) * 100
                symbol = "ðŸ”´" if change > 5 else "ðŸŸ¢" if change < -5 else "âšª"
                print(f"| {name} | {b} | {c} | {symbol} {change:+.1f}% |")
            elif name in base:
                print(f"| {name} | {base[name]} | N/A | âŒ Missing |")
            else:
                print(f"| {name} | N/A | {current[name]} | âœ… New |")
        EOF
        
        python3 compare.py >> comparison.md || echo "Failed to generate comparison table" >> comparison.md
    
    - name: Comment PR
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const comparison = fs.readFileSync('comparison.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comparison
          });